services:
  postgres:
    image: postgres:16
    # load credentials from .env in the same directory as this compose file
    env_file: .env
    environment:
      POSTGRES_USER: airflow
      POSTGRES_PASSWORD: airflow
      POSTGRES_DB: warehouse
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./db/init:/docker-entrypoint-initdb.d
    ports: ["5432:5432"]

  adminer:
    image: adminer
    ports: ["8081:8080"]
    depends_on: [postgres]

  airflow:
    build:
      context: .
      dockerfile: Dockerfile
    image: woz-airflow:3.1.0
    # load Airflow / Postgres creds from .env (this file is located in `./airflow/.env`)
    env_file: .env
    environment:
      AIRFLOW__CORE__LOAD_EXAMPLES: "False"
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@postgres:5432/warehouse
      AIRFLOW__CORE__AUTH_MANAGER: airflow.providers.fab.auth_manager.fab_auth_manager.FabAuthManager
      _AIRFLOW_DB_MIGRATE: 'true'
      _AIRFLOW_WWW_USER_CREATE: 'true'
      _AIRFLOW_WWW_USER_USERNAME: ${_AIRFLOW_WWW_USER_USERNAME:-admin}
      _AIRFLOW_WWW_USER_PASSWORD: ${_AIRFLOW_WWW_USER_PASSWORD:-admin}
      # Override default postgres connection to use correct warehouse credentials
  AIRFLOW_CONN_POSTGRES_DEFAULT: postgresql://airflow:airflow@postgres:5432/warehouse
  # Neo4j/Redis defaults (override via .env if needed)
  AIRFLOW_CONN_NEO4J_DEFAULT: ${AIRFLOW_CONN_NEO4J_DEFAULT:-neo4j://neo4j:neo4j@neo4j:7687}
  AIRFLOW_CONN_REDIS_DEFAULT: ${AIRFLOW_CONN_REDIS_DEFAULT:-redis://redis:6379/0}
      # Pass Postgres credentials from .env to Airflow for direct connections
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: warehouse
      POSTGRES_USER: ${POSTGRES_USER:-airflow}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-airflow}
  # Direct client env vars
  NEO4J_URI: ${NEO4J_URI:-bolt://neo4j:7687}
  NEO4J_USER: ${NEO4J_USER:-neo4j}
  NEO4J_PASSWORD: ${NEO4J_PASSWORD:-neo4j}
  version: "3.8"

  services:
    postgres:
      image: postgres:16
      env_file: .env
      environment:
        POSTGRES_USER: airflow
        POSTGRES_PASSWORD: airflow
        POSTGRES_DB: warehouse
      volumes:
        - pgdata:/var/lib/postgresql/data
        - ./db/init:/docker-entrypoint-initdb.d
      ports:
        - "5432:5432"

    adminer:
      image: adminer
      ports:
        - "8081:8080"
      depends_on:
        - postgres

    airflow:
      build:
        context: .
        dockerfile: Dockerfile
      image: woz-airflow:3.1.0
      env_file: .env
      environment:
        AIRFLOW__CORE__LOAD_EXAMPLES: "False"
        AIRFLOW__CORE__EXECUTOR: LocalExecutor
        AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@postgres:5432/warehouse
        AIRFLOW__CORE__AUTH_MANAGER: airflow.providers.fab.auth_manager.fab_auth_manager.FabAuthManager
        _AIRFLOW_DB_MIGRATE: "true"
        _AIRFLOW_WWW_USER_CREATE: "true"
        _AIRFLOW_WWW_USER_USERNAME: ${_AIRFLOW_WWW_USER_USERNAME:-admin}
        _AIRFLOW_WWW_USER_PASSWORD: ${_AIRFLOW_WWW_USER_PASSWORD:-admin}
        AIRFLOW_CONN_POSTGRES_DEFAULT: postgresql://airflow:airflow@postgres:5432/warehouse
        AIRFLOW_CONN_NEO4J_DEFAULT: ${AIRFLOW_CONN_NEO4J_DEFAULT:-neo4j://neo4j:neo4j@neo4j:7687}
        AIRFLOW_CONN_REDIS_DEFAULT: ${AIRFLOW_CONN_REDIS_DEFAULT:-redis://redis:6379/0}
        POSTGRES_HOST: postgres
        POSTGRES_PORT: 5432
        POSTGRES_DB: warehouse
        POSTGRES_USER: ${POSTGRES_USER:-airflow}
        POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-airflow}
        NEO4J_URI: ${NEO4J_URI:-bolt://neo4j:7687}
        NEO4J_USER: ${NEO4J_USER:-neo4j}
        NEO4J_PASSWORD: ${NEO4J_PASSWORD:-neo4j}
        REDIS_HOST: ${REDIS_HOST:-redis}
        REDIS_PORT: ${REDIS_PORT:-6379}
        REDIS_DB: ${REDIS_DB:-0}
      user: "${AIRFLOW_UID:-50000}:0"
      volumes:
        - ./dags:/opt/airflow/dags
        - ./data:/opt/airflow/data
        - ./data/product-database:/opt/airflow/data/product-database
      command: >
        bash -lc "airflow dag-processor & airflow api-server & airflow scheduler"
      ports:
        - "8080:8080"
      depends_on:
        - postgres
        - neo4j
        - redis

    neo4j:
      image: neo4j:5.24
      environment:
        - NEO4J_AUTH=${NEO4J_AUTH:-neo4j/neo4j}
        - NEO4J_server_memory_heap_initial__size=512m
        - NEO4J_server_memory_heap_max__size=1g
      ports:
        - "7474:7474"
        - "7687:7687"
      volumes:
        - neo4j:/data

    redis:
      image: redis:7-alpine
      command: ["redis-server", "--appendonly", "yes"]
      ports:
        - "6379:6379"
      volumes:
        - redisdata:/data

  volumes:
    pgdata:
    neo4j:
    redisdata:
  
  
  
  

  
  
  
  

  
  
  
  

  
  
  
  

  
  
  
  

  
  
  
  

  
  
  
  

  
  
  
  

  
  
  
  

  
  
  
  

  
  
  
  

  
  
  
  

  
  
  
  

  
  
  
  

  
  
  
  

  
  
  
  

  
  
  
  

  
  
  
  


  neo4j:
    image: neo4j:5.24
    environment:
      - NEO4J_AUTH=${NEO4J_AUTH:-neo4j/neo4j}
      - NEO4J_server_memory_heap_initial__size=512m
      - NEO4J_server_memory_heap_max__size=1g
    ports:
      - "7474:7474"
      - "7687:7687"
    volumes:
      - neo4j:/data

  redis:
    image: redis:7-alpine
    command: ["redis-server", "--appendonly", "yes"]
    ports:
      - "6379:6379"
    volumes:
      - redisdata:/data
